name: Security Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
# ==================================================
# 1️⃣ Build
# ==================================================
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      start_time: ${{ steps.timer.outputs.start }}
      duration: ${{ steps.timer.outputs.duration }}

    steps:
      - uses: actions/checkout@v4

      - id: timer
        run: |
          START=$(date +%s)
          echo "start=$START" >> $GITHUB_OUTPUT

          echo "Building..."
          sleep 1

          END=$(date +%s)
          echo "duration=$((END - START))" >> $GITHUB_OUTPUT

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '8'

      - run: chmod +x gradlew
      - run: ./gradlew build
      - run: ./gradlew jibDockerBuild

# ==================================================
# 2️⃣ SBOM – Trivy
# ==================================================
  sbom:
    runs-on: ubuntu-latest
    needs: build

    outputs:
      duration: ${{ steps.timer.outputs.duration }}

    steps:
      - uses: actions/checkout@v4

      - id: timer
        run: |
          START=$(date +%s)

          trivy image sasanlabs/owasp-vulnerableapp:unreleased \
            --scanners sbom \
            --format cyclonedx \
            --output trivy-sbom.json || true

          END=$(date +%s)
          echo "duration=$((END - START))" >> $GITHUB_OUTPUT

# ==================================================
# 3️⃣ Dependency Check
# ==================================================
  dependency-check:
    runs-on: ubuntu-latest
    needs: sbom

    outputs:
      duration: ${{ steps.timer.outputs.duration }}

    steps:
      - uses: actions/checkout@v4

      - id: timer
        run: |
          START=$(date +%s)

          dependency-check.sh \
            --project VulnerableApp \
            --scan . \
            --format HTML || true

          END=$(date +%s)
          echo "duration=$((END - START))" >> $GITHUB_OUTPUT

# ==================================================
# 4️⃣ Trivy Scan
# ==================================================
  trivy-scan:
    runs-on: ubuntu-latest
    needs: dependency-check

    outputs:
      duration: ${{ steps.timer.outputs.duration }}

    steps:
      - uses: actions/checkout@v4

      - id: timer
        run: |
          START=$(date +%s)

          trivy image sasanlabs/owasp-vulnerableapp:unreleased \
            --scanners vuln,secret \
            --severity CRITICAL,HIGH,MEDIUM,LOW \
            --format sarif \
            --output trivy-results.sarif || true

          END=$(date +%s)
          echo "duration=$((END - START))" >> $GITHUB_OUTPUT

      - uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif

# ==================================================
# 5️⃣ SAST – Semgrep
# ==================================================
  sast:
    runs-on: ubuntu-latest

    outputs:
      duration: ${{ steps.timer.outputs.duration }}

    steps:
      - uses: actions/checkout@v4

      - id: timer
        run: |
          START=$(date +%s)
          semgrep ci || true
          END=$(date +%s)
          echo "duration=$((END - START))" >> $GITHUB_OUTPUT

# ==================================================
# 6️⃣ Secret Scan – TruffleHog
# ==================================================
  secret-scan:
    runs-on: ubuntu-latest

    outputs:
      duration: ${{ steps.timer.outputs.duration }}

    steps:
      - uses: actions/checkout@v4

      - id: timer
        run: |
          START=$(date +%s)
          trufflehog filesystem . || true
          END=$(date +%s)
          echo "duration=$((END - START))" >> $GITHUB_OUTPUT

# ==================================================
# 7️⃣ Metrics Summary
# ==================================================
  metrics-summary:
    runs-on: ubuntu-latest
    needs:
      - build
      - sbom
      - dependency-check
      - trivy-scan
      - sast
      - secret-scan

    steps:
      - name: Print metrics
        run: |
          TOTAL=$(( \
            ${{ needs.build.outputs.duration }} +
            ${{ needs.sbom.outputs.duration }} +
            ${{ needs.dependency-check.outputs.duration }} +
            ${{ needs.trivy-scan.outputs.duration }} +
            ${{ needs.sast.outputs.duration }} +
            ${{ needs.secret-scan.outputs.duration }} \
          ))

          echo "========== PIPELINE METRICS =========="
          echo "Build:              ${{ needs.build.outputs.duration }}s"
          echo "SBOM:               ${{ needs.sbom.outputs.duration }}s"
          echo "Dependency Check:   ${{ needs.dependency-check.outputs.duration }}s"
          echo "Trivy Scan:         ${{ needs.trivy-scan.outputs.duration }}s"
          echo "Semgrep:            ${{ needs.sast.outputs.duration }}s"
          echo "TruffleHog:         ${{ needs.secret-scan.outputs.duration }}s"
          echo "-------------------------------------"
          echo "TOTAL PIPELINE:     ${TOTAL}s"
